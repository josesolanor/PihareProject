@model IEnumerable<WebPihare.Entities.Client>

@{
    ViewData["Title"] = "Mis Clientes";
}

<h2>Clientes</h2>

<div class="demo-container">
    <div id="clientGrid"></div>
</div>

<script>

    $.ajax({
        url: '@Url.Action("MyLoadGrid", "Clients")',
        type: "GET"
    }).done(function (response) {

        var dataSourceMaster = response.master;
        var dataSourceDetail = response.detail;
        var dataSourceDetail2 = response.detail2;

        $(function(){
            $("#clientGrid").dxDataGrid({
                dataSource: dataSourceMaster,
                keyExpr: "clientId",
                allowColumnReordering: true,
                allowColumnResizing: true,
                columnAutoWidth: true,
                showColumnLines: true,
                showRowLines: true,
                rowAlternationEnabled: true,
                showBorders: true,
                columnChooser: {
                enabled: true
                },
                filterRow: {
                    visible: true,
                },
                headerFilter: { visible: true },
                paging: {
                    pageSize: 10
                },
                pager: {
                    showPageSizeSelector: true,
                    allowedPageSizes: [10, 25, 50, 100]
                },
                selection: {
                    mode: "single"
                },
                grouping: {
                    autoExpandAll: true
                },
                headerFilter: {
                    visible: true
                },
                groupPanel: {
                    visible: false
                },
                "export": {
                    enabled: true,
                    fileName: "RegistroClientes"+Date.now(),
                    allowExportSelectedData: true
                },
                columns: [
                    {
                        dataField: "clientId",
                        visible: false
                    },
                    {
                        dataField: "firstName",
                        caption: 'Nombre'
                    },
                    {
                        dataField: "lastName",
                        caption: 'Apellido Paterno'
                    },
                    {
                        dataField: "secondLastName",
                        caption: 'Apellido Materno'
                    },
                    {
                        dataField: "ci",
                        caption: 'C.I.'
                    },
                    {
                        dataField: "registredDate",
                        caption: 'Fecha de Registo',
                        dataType: "date",
                        format: 'dd/MM/yyyy HH:mm:ss'
                    },
                    {
                        dataField: "observation",
                        caption: 'Observaciones'
                    }                    
                ],
                masterDetail: {
                enabled: true,
                    template: function (container, options)
                    {
                    var currentClientData = options.data;
                        $("<div>")
                            .addClass("master-detail-caption")
                            .text("Departamentos de " + currentClientData.firstName + " " + currentClientData.lastName)
                            .appendTo(container);

                        $("<div>")
                            .dxDataGrid({
                                columnAutoWidth: true,
                                showBorders: true,
                                columns: [
                                {
                                    dataField: "clientId",
                                    visible: false
                                },
                                {
                                    dataField: "departmentId",
                                    visible: false
                                },
                                {
                                    dataField: "departmentCode",
                                    caption: 'Codigo Departamento'
                                },
                                {
                                    dataField: "numberFloor",
                                    caption: 'Piso'
                                },
                                {
                                    dataField: "numberBedrooms",
                                    caption: 'Dormitorios'
                                },
                                {
                                    dataField: "deparmentPrice",
                                    caption: 'Precio'
                                }
                                ],
                                dataSource: new DevExpress.data.DataSource({
                                    store: new DevExpress.data.ArrayStore({
                                        key: "departmentId",
                                        data: dataSourceDetail
                                    }),
                                    filter: ["clientId", "=", options.key]
                                })
                            }).appendTo(container);

                        $("<div>")
                            .addClass("master-detail-caption")
                            .text("Visitas de " + currentClientData.firstName + " " + currentClientData.lastName)
                            .appendTo(container);

                        $("<div>")
                            .dxDataGrid({
                                columnAutoWidth: true,
                                showBorders: true,
                                columns: [
                                {
                                    dataField: "clientId",
                                    visible: false
                                },
                                {
                                    dataField: "visitRegistrationId",
                                    visible: false
                                },
                                {
                                    dataField: "visitDay",
                                    caption: 'Fecha',
                                    dataType: "date",
                                    format: 'dd/MM/yyyy HH:mm:ss'
                                },
                                {
                                    dataField: "departmentCode",
                                    caption: 'Codigo Dpto'
                                },
                                {
                                    dataField: "stateVisitStateValue",
                                    caption: 'Estado'
                                },                                
                                {
                                    dataField: "commisionerFullName",
                                    caption: 'Comisionista Asignado'
                                }
                                ],
                                dataSource: new DevExpress.data.DataSource({
                                    store: new DevExpress.data.ArrayStore({
                                        key: "visitRegistrationId",
                                        data: dataSourceDetail2
                                    }),
                                    filter: ["clientId", "=", options.key]
                                })
                            }).appendTo(container);
                    }
                }
            });
        });

    });
</script>
